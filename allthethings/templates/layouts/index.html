<html lang="{{ g.current_lang_code }}">
  <head>
    <meta charset="utf-8">
    <title>{% if self.title() %}{% block title %}{% endblock %} - {% endif %}{{ gettext('layout.index.title') }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}">
    {% if self.meta_tags() %}
      {% block meta_tags %}{% endblock %}
    {% else %}
      <meta name="description" content="Search engine of shadow libraries: books, papers, comics, magazines." />
    {% endif %}
    <meta name="twitter:card" value="summary">
    <meta name="twitter:creator" content="@AnnaArchivist"/>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
  </head>
  <body>
    <div class="header" role="navigation">
      <div class="bg-[#0195ff] hidden js-top-banner">
        <div class="max-w-[850px] mx-auto px-4 py-2 text-[#fff] flex">
          <div>
            {{ gettext('layout.index.header.banner.new_donation_method', method_name=('<strong>Paypal</strong>' | safe), donate_link_open_tag=('<a href="/donate" class="custom-a text-[#fff] hover:text-[#ddd] underline">' | safe)) }}
          </div>
          <div>
            <a href="#" class="custom-a text-[#fff] hover:text-[#ddd] js-top-banner-close">‚úï</a>
          </div>
        </div>
      </div>
      <script>
        (function() {
          var latestTopBannerType = '1';
          var topBannerMatch = document.cookie.match(/top_banner_hidden=([^$ ;}]+)/);
          var topBannerType = '';
          if (topBannerMatch) {
            topBannerType = topBannerMatch[1];
            // Refresh cookie.
            document.cookie = 'top_banner_hidden=' + topBannerType + ';path=/;expires=Fri, 31 Dec 9999 23:59:59 GMT';
          }
          if (topBannerType !== latestTopBannerType) {
            document.querySelector('.js-top-banner').style.display = 'block';
            document.querySelector('.js-top-banner-close').addEventListener('click', function() {
              document.querySelector('.js-top-banner').style.display = 'none';
              document.cookie = 'top_banner_hidden=' + latestTopBannerType + ';path=/;expires=Fri, 31 Dec 9999 23:59:59 GMT';
              return false;
            });
          }
        })();
      </script>
      <div class="header-inner">
        <div class="header-inner-top">
          <a href="/" class="custom-a text-[#000] hover:text-[#444]"><h1>{{ gettext('layout.index.header.title') }}</h1></a>

          <script>
            (function() {
              if (location.hostname.includes('localhost')) {
                location.hostname = location.hostname.replace('localhost', 'localtest.me');
                return;
              }

              var langCodes = [{% for lang_code, _lang_name in g.languages %}{{ lang_code | tojson }}, {% endfor %}];

              var domainPosition = 0;
              var potentialSubDomainLangCode = location.hostname.split(".")[0];
              var subDomainLangCode = 'en';
              if (langCodes.includes(potentialSubDomainLangCode) || potentialSubDomainLangCode === 'www') {
                domainPosition = potentialSubDomainLangCode.length + 1;
                if (potentialSubDomainLangCode !== 'www') {
                  subDomainLangCode = potentialSubDomainLangCode;
                }
              }

              baseDomain = location.hostname.substring(domainPosition);

              function setLangCookie(langCode) {
                if (!langCodes.includes(langCode)) {
                  return;
                }
                document.cookie = 'selected_lang=' + langCode + ';path=/;expires=Fri, 31 Dec 9999 23:59:59 GMT;domain=' + baseDomain;
              }

              function redirectLang(langCode) {
                if (!langCodes.includes(langCode)) {
                  return;
                }
                var prefix = '';
                if (langCode != 'en') {
                  prefix = langCode + '.';
                }
                location.hostname = prefix + baseDomain;
              }

              window.handleChangeLang = function(event) {
                const langCode = event.target.value;
                setLangCookie(langCode);
                redirectLang(langCode);
              };

              var cookieLangMatch = document.cookie.match(/selected_lang=([^$ ;}]+)/);
              if (cookieLangMatch) {
                // Refresh cookie with a new expiry, in case the browser has
                // restricted it.
                var explicitlyRequestedLangCode = cookieLangMatch[1];
                setLangCookie(explicitlyRequestedLangCode);

                // If a cookie is set, that means the user at some point explicitly 
                // selected a language, so redirect to that language.
                if (explicitlyRequestedLangCode != subDomainLangCode) {
                  redirectLang(explicitlyRequestedLangCode);
                }
              } else {
                // Otherwise, see if the user's browser language is one that we support directly.
                for (const langCode of navigator.languages) {
                  // Take the first language that we support, and if we're already there
                  // be sure to bail out so we don't redirect to a suboptimal language.
                  if (langCodes.includes(langCode)) {
                    if (langCode != subDomainLangCode) {
                      redirectLang(langCode);
                    }
                    break;
                  }
                }
              }
            })();
          </script>
          <select class="p-1 rounded text-gray-500 max-w-[50px] mt-1 ml-2" onchange="handleChangeLang(event)">
            <option>üåê</option>
            {% for lang_code, lang_name in g.languages %}
              <option value="{{ lang_code }}">{{ lang_name }} [{{ lang_code }}]{% if lang_code == g.current_lang_code %} ‚òëÔ∏è{% endif %}</option>
            {% endfor %}
          </select>
        </div>

        <div>{{ gettext('layout.index.header.tagline') }}</div>

        <div style="position: relative; height: 16px; margin-top: 16px">
          <div style="position: absolute; left: 0; right: 0; top: 0; bottom: 0; background: white; overflow: hidden; border-radius: 16px; box-shadow: 0px 2px 4px 0px #00000038">
            <div style="position: absolute; left: 0; top: 0; bottom: 0; width: 5%; background: #0095ff"></div>
          </div>
          <div style="position: absolute; left: 5%; top: 50%; width: 16px; height: 16px; transform: translate(-50%, -50%)">
            <div style="position: absolute; left: 0; top: 0; width: 16px; height: 16px; background: #0095ff66; border-radius: 100%; animation: header-ping 1.5s cubic-bezier(0,0,.2,1) infinite"></div>
            <div style="position: absolute; left: 0; top: 0; width: 16px; height: 16px; background: white; border-radius: 100%; box-shadow: 0 0 3px #00000069;"></div>
          </div>
        </div>

        <div style="position: relative; padding-bottom: 20px">
          <div style="width: 14px; height: 14px; border-left: 1px solid gray; border-bottom: 1px solid gray; position: absolute; top: 5px; left: calc(5% - 1px)"></div>
          <div style="position: relative; left: calc(5% + 20px); width: calc(90% - 20px); top: 8px; font-size: 90%; color: #555">{{ gettext('layout.index.header.progress_bar.text', info_icon=('<a href="/about" style="text-decoration: none !important;">‚ìò</a>' | safe)) }}</div>
        </div>
        <div class="header-bar">
          <div class="header-links">
            <a href="/" class="{{ 'header-link-active' if header_active == 'home' }}"><span class="header-link-normal">{{ gettext('layout.index.header.nav.home') }}</span><span class="header-link-bold">{{ gettext('layout.index.header.nav.home') }}</span></a>
            <a href="/about" class="{{ 'header-link-active' if header_active == 'about' }}"><span class="header-link-normal">{{ gettext('layout.index.header.nav.about') }}</span><span class="header-link-bold">{{ gettext('layout.index.header.nav.about') }}</span></a>
            <a href="/donate" class="{{ 'header-link-active' if header_active == 'donate' }}"><span class="header-link-normal">{{ gettext('layout.index.header.nav.donate') }}</span><span class="header-link-bold">{{ gettext('layout.index.header.nav.donate') }}</span></a>
            <a href="/search" class="{{ 'header-link-active' if header_active == 'search' }}"><span class="header-link-normal">{{ gettext('layout.index.header.nav.search') }}</span><span class="header-link-bold">{{ gettext('layout.index.header.nav.search') }}</span></a>
          </div>
          <form class="header-search" action="/search" method="get" role="search">
            <input name="q" type="text" placeholder="{{ gettext('common.search.placeholder') }}" value="{{search_input}}">
          </form>
        </div>
      </div>
    </div>
    <main class="main">{% block body %}{% endblock %}</main>
    <footer class="bg-[#0000000d]" style="box-shadow: 0px 0px 7px rgb(0 0 0 / 30%)">
      <div class="max-w-[850px] mx-auto p-[12px] leading-relaxed flex">
        <p class=" mr-16" style="flex-grow: 1">
          <strong class="font-bold">{{ gettext('layout.index.footer.list1.header') }}</strong><br>
          <a class="custom-a text-[#777] hover:text-[#333]" href="/">{{ gettext('layout.index.footer.list1.home') }}</a><br>
          <a class="custom-a text-[#777] hover:text-[#333]" href="/about">{{ gettext('layout.index.footer.list1.about') }}</a><br>
          <a class="custom-a text-[#777] hover:text-[#333]" href="/donate">{{ gettext('layout.index.footer.list1.donate') }}</a><br>
          <a class="custom-a text-[#777] hover:text-[#333]" href="/datasets">{{ gettext('layout.index.footer.list1.datasets') }}</a><br>
          <select class="p-1 rounded text-gray-500 mt-1" onchange="handleChangeLang(event)">
            {% for lang_code, lang_name in g.languages %}
              {% if g.current_lang_code == lang_code %}
                <option value="{{ lang_code }}">üåê {{ lang_name }} [{{ lang_code }}]</option>
              {% endif %}
            {% endfor %}
            {% for lang_code, lang_name in g.languages %}
              <option value="{{ lang_code }}">{{ lang_name }} [{{ lang_code }}]{% if lang_code == g.current_lang_code %} ‚òëÔ∏è{% endif %}</option>
            {% endfor %}
          </select>
        </p>
        <p style="flex-grow: 2">
          <strong class="font-bold">{{ gettext('layout.index.footer.list2.header') }}</strong><br>
          <a class="custom-a text-[#777] hover:text-[#333]" href="https://twitter.com/AnnaArchivist">{{ gettext('layout.index.footer.list2.twitter') }}</a> / <a class="custom-a text-[#777] hover:text-[#333]" href="https://www.reddit.com/user/AnnaArchivist">{{ gettext('layout.index.footer.list2.reddit') }}</a> / <a class="custom-a text-[#777] hover:text-[#333]" href="https://www.reddit.com/r/Annas_Archive">{{ gettext('layout.index.footer.list2.subreddit') }}</a><br>
          <a class="custom-a text-[#777] hover:text-[#333]" href="https://annas-blog.org">{{ gettext('layout.index.footer.list2.blog') }}</a><br>
          <a class="custom-a text-[#777] hover:text-[#333]" href="https://annas-software.org">{{ gettext('layout.index.footer.list2.software') }}</a><br>
          <a class="custom-a text-[#777] hover:text-[#333]" href="mailto:AnnaArchivist@proton.me">AnnaArchivist@&#8203;proton.&#8203;me</a><br>
        </p>
      </div>
    </footer>
  </body>
